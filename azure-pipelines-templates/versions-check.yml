# Copyright (c) .NET Foundation and Contributors
# See LICENSE file in the project root for full license information.

steps:

  - task: PowerShell@2
    condition: >-
      and(
        succeeded(),
        eq(variables['StartReleaseCandidate'], false),
        not(startsWith(variables['Build.SourceBranch'], 'refs/tags/v'))
      )
    displayName: Prep VersionCop
    name: PrepVersionCop
    inputs:
      targetType: 'inline'
      script: |

        if($null -eq "$(solution)")
        {
            $SolutionToCheck = $env:SOLUTION_TO_CHECK
        }
        else
        {
            $SolutionToCheck = "$(solution)"
        }

        echo "##vso[task.setvariable variable=SolutionToCheck;isOutput=true]$SolutionToCheck" 

        Set-Location $env:Agent_TempDirectory

        # clone tools repo
        git clone https://github.com/nanoframework/nf-tools.git -b main nftools --depth=1

  - task: DotNetCoreCLI@2
    displayName: 'Check versions match'
    condition: >-
      and(
        succeeded(),
        eq(variables['StartReleaseCandidate'], false),
        not(startsWith(variables['Build.SourceBranch'], 'refs/tags/v'))
      )
    inputs:
      command: 'run'
      projects: '$(Agent.TempDirectory)/nftools/tools/VersionCop'
      arguments: '-- --working-directory $(System.DefaultWorkingDirectory) --solution-to-check $(PrepVersionCop.SolutionToCheck) --nuspec-file $(nugetPackageName).nuspec'
    